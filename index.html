<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPP</title>
  
  <link rel="icon" type="image/png" href="icone.png">

  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Space Grotesk', sans-serif; }
    html, body { height: 100%; width: 100%; }
    body { background: #0f172a; color: #e2e8f0; margin: 0; overflow: hidden; }
    #app { display: flex; flex-direction: column; height: 100%; width: 100%; }
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    
    .import-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .import-modal.hidden { display: none; }
    .import-modal-content { background: #1e293b; border: 2px solid #6366f1; border-radius: 12px; padding: 24px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; }
    
    .main-wrapper { display: flex; flex: 1; overflow: hidden; gap: 0; }
    .list-panel { flex: 1; border-right: 2px solid rgba(99, 102, 241, 0.3); overflow-y: auto; background: rgba(30, 41, 59, 0.5); }
    
    .list-header { 
      position: sticky; 
      top: 0; 
      background: rgba(30, 41, 59, 0.95); 
      border-bottom: 2px solid rgba(99, 102, 241, 0.3); 
      font-weight: bold; 
      font-size: 11px; 
      color: #a78bfa; 
      z-index: 20; 
      display: grid; 
      grid-template-columns: 1fr 120px 120px 100px 100px; 
      gap: 0; 
      padding: 0;
      text-transform: uppercase; 
      letter-spacing: 0.5px;
    }
    
    .header-cell { 
      padding: 14px; 
      border-right: 1px solid rgba(99, 102, 241, 0.2);
      display: flex; 
      align-items: center;
    }
    
    .header-cell:last-child { border-right: none; }
    
    .plan-group { border-bottom: 2px solid rgba(99, 102, 241, 0.3); }
    
    .plan-folder { 
      background: rgba(99, 102, 241, 0.15); 
      padding: 0; 
      display: grid; 
      grid-template-columns: 1fr 120px 120px 100px 100px; 
      gap: 0; 
      border-left: 4px solid #6366f1; 
      cursor: pointer; 
      transition: all 0.2s;
      border-bottom: 1px solid rgba(99, 102, 241, 0.2);
    }
    
    .plan-folder:hover { background: rgba(99, 102, 241, 0.25); }
    
    .plan-folder-title { 
      padding: 14px; 
      font-weight: 700; 
      color: #a78bfa; 
      font-size: 12px; 
      display: flex; 
      align-items: center; 
      gap: 10px;
    }
    
    .plan-count-badge { font-size: 10px; color: #94a3b8; margin-left: 8px; background: rgba(71, 85, 105, 0.3); padding: 2px 6px; border-radius: 3px; }
    
    .plan-folder-empty { 
      padding: 14px; 
      border-right: 1px solid rgba(99, 102, 241, 0.2);
      display: flex;
      align-items: center;
    }
    
    .plan-progress-container {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: rgba(71, 85, 105, 0.2);
      border-radius: 4px;
      margin: 8px 14px;
      font-size: 10px;
      color: #cbd5e1;
    }
    
    .plan-progress-label {
      font-weight: 600;
      min-width: 30px;
    }
    
    .plan-progress-bar {
      flex: 1;
      height: 6px;
      background: rgba(71, 85, 105, 0.4);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }
    
    .plan-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #6366f1);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .list-row { 
      display: grid; 
      grid-template-columns: 1fr 120px 120px 100px 100px; 
      gap: 0; 
      padding: 0; 
      border-bottom: 1px solid rgba(71, 85, 105, 0.2);
      transition: all 0.2s ease;
      margin-left: 20px;
    }
    
    .list-row:hover { background: rgba(99, 102, 241, 0.1); }
    .list-row.highlighted { background: rgba(99, 102, 241, 0.3) !important; border-left: 3px solid #6366f1; }
    .list-row.hidden { display: none; }
    
    .list-cell { 
      padding: 12px 14px; 
      border-right: 1px solid rgba(99, 102, 241, 0.15); 
      display: flex; 
      flex-direction: column;
      justify-content: center;
    }
    
    .list-cell:last-child { border-right: none; }
    
    .activity-name { font-weight: 600; color: #e2e8f0; font-size: 12px; }
    .activity-phase { font-size: 11px; color: #a78bfa; margin-top: 2px; }
    
    .cell-date { font-family: 'Courier New', monospace; font-size: 11px; color: #cbd5e1; }
    .cell-progress { font-size: 12px; font-weight: 600; color: #22c55e; }
    .cell-status { font-size: 10px; padding: 2px 6px; border-radius: 3px; display: inline-block; }
    .status-on-time { background: rgba(34, 197, 94, 0.3); color: #22c55e; }
    .status-delayed { background: rgba(239, 68, 68, 0.3); color: #ef4444; }
    
    .dashboard-panel { 
      width: 350px; 
      border-left: 2px solid rgba(99, 102, 241, 0.3); 
      background: rgba(30, 41, 59, 0.5); 
      overflow-y: auto; 
      padding: 16px; 
      transition: all 0.3s ease;
    }
    .dashboard-panel.hidden { 
      width: 0; 
      padding: 0; 
      border: none; 
      overflow: hidden; 
    }
    
    .dashboard-plan-section { margin-bottom: 16px; }
    .dashboard-plan-header { 
      font-weight: 700; 
      color: #6366f1; 
      font-size: 11px; 
      padding: 8px 10px; 
      background: rgba(99, 102, 241, 0.15); 
      border-left: 3px solid #6366f1; 
      margin-bottom: 8px; 
      border-radius: 3px; 
      text-transform: uppercase; 
      letter-spacing: 0.5px;
    }
    
    .dashboard-card { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .dashboard-title { color: #a78bfa; font-weight: bold; font-size: 11px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .dashboard-item { 
      background: rgba(71, 85, 105, 0.3); 
      border-left: 3px solid #3b82f6; 
      padding: 10px; 
      border-radius: 4px; 
      margin-bottom: 8px; 
      font-size: 11px; 
      cursor: pointer; 
      transition: all 0.2s ease; 
    }
    .dashboard-item.delayed { border-left-color: #ef4444; }
    .dashboard-item.upcoming { border-left-color: #3b82f6; }
    .dashboard-item:hover { background: rgba(99, 102, 241, 0.2); }
    .dashboard-item.highlighted { background: rgba(99, 102, 241, 0.4) !important; }
    .dashboard-item-name { font-weight: 600; color: #e2e8f0; }
    .dashboard-item-phase { font-size: 10px; color: #94a3b8; margin-top: 2px; }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body>
  <div id="app">
   <header class="bg-slate-800/50 border-b border-slate-700 p-4 flex justify-between items-center">
    <div class="flex items-center gap-4">
     <img id="company-logo" src="logo.png" alt="Logo" class="w-14 h-14 rounded-lg object-cover bg-slate-800 border border-slate-700">
     
     <div>
      <h1 id="plan-title" class="text-2xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">GPP</h1>
      <p class="text-slate-400 text-sm mt-1">Data de Emiss√£o: <span id="today-date" class="font-semibold text-indigo-300">--/--/----</span></p>
     </div>
    </div>
    
    <div class="flex gap-2">
      <button id="collapse-all-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium text-sm"> üìÇ Recolher Todos </button> 
      <button id="expand-all-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium text-sm"> üìÅ Expandir Todos </button> 
      <button id="toggle-dashboard-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors font-medium text-sm"> üìä Ocultar Dashboard </button> 
      <button id="import-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium text-sm"> üì• Importar Excel </button>
    </div>
   </header>

   <div id="import-modal" class="import-modal hidden">
    <div class="import-modal-content">
     <h2 class="text-xl font-bold text-indigo-400 mb-4">üìä Importar Excel</h2>
     <p class="text-slate-300 text-sm mb-4">Selecione um arquivo com suas atividades</p><input type="file" id="excel-file" accept=".xlsx,.xls" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-300 text-sm mb-4">
     <div id="import-preview" class="mb-4 bg-slate-700/50 p-3 rounded max-h-96 overflow-y-auto hidden text-xs text-slate-300"></div>
     <div class="flex gap-2"><button id="import-cancel" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium text-sm transition"> Cancelar </button> <button id="import-confirm" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition"> Importar </button>
     </div>
     <div id="import-status" class="mt-4 p-3 rounded text-sm hidden"></div>
    </div>
   </div>
   <div class="main-wrapper">
    <div class="list-panel" id="list-panel">
     <div class="list-header">
      <div class="header-cell">
       Atividades GPP
      </div>
      <div class="header-cell">
       In√≠cio
      </div>
      <div class="header-cell">
       Fim
      </div>
      <div class="header-cell">
       Progresso
      </div>
      <div class="header-cell">
       Status
      </div>
     </div>
     <div id="list-content"></div>
    </div>
    <div class="dashboard-panel" id="dashboard-panel">
     <h3 class="text-sm font-bold text-purple-400 mb-4">üìä Dashboard Geral</h3>
     <div id="dashboard-overview"></div>
     <h3 class="text-sm font-bold text-purple-400 mb-4">üìã Por Plano</h3>
     <div id="dashboard-content"></div>
    </div>
   </div>
  </div>
  <script>
    // --- CONFIGURA√á√ÉO DA NUVEM ---
    const BIN_ID = '6992f9d5d0ea881f40bea147'; 
    const API_KEY = '$2a$10$T3C70qhYrKZMczxOir2xUeypvmxIZ89FRuioGyxBSh/gZorc4iBAy'; 
    // -----------------------------

    let activities = [];
    let collapsedPlans = {};
    let dashboardVisible = true;

    const today = new Date();
    document.getElementById('today-date').textContent = today.toLocaleDateString('pt-BR');

    // --- FUN√á√ïES DE NUVEM (JSONBin) ---
    
    async function saveData() {
      const btn = document.getElementById('import-confirm');
      const originalText = btn.textContent;
      btn.textContent = 'Salvando na nuvem...';
      
      try {
        const title = document.getElementById('plan-title').textContent;
        const dataToSave = {
          title: title,
          updatedAt: new Date().toISOString(),
          activities: activities
        };

        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': API_KEY
          },
          body: JSON.stringify(dataToSave)
        });

        if (!response.ok) throw new Error('Erro na API');
        console.log('Dados salvos na nuvem com sucesso!');
        
      } catch (e) {
        console.error('Erro ao salvar:', e);
        alert('Erro ao salvar na nuvem. Verifique o console (F12).');
      } finally {
        btn.textContent = originalText;
      }
    }

    async function loadData() {
      // Mostra um estado de carregamento
      document.getElementById('list-content').innerHTML = '<div class="p-4 text-slate-400">üîÑ Buscando dados mais recentes na nuvem...</div>';

      try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
          method: 'GET',
          headers: {
            'X-Master-Key': API_KEY
          }
        });

        if (!response.ok) throw new Error('Erro ao buscar dados');

        const result = await response.json();
        const data = result.record; // O JSONBin retorna os dados dentro de "record"

        if (data.title) {
          document.getElementById('plan-title').textContent = data.title;
        }
        
        if (data.activities && Array.isArray(data.activities)) {
          // Reconstr√≥i as datas
          activities = data.activities.map(act => {
            return {
              ...act,
              inicioDate: new Date(act.inicioDate),
              fimDate: new Date(act.fimDate)
            };
          });
          
          renderList();
          updateDashboard();
          
          // Feedback visual
          const date = new Date(data.updatedAt);
          showStatus(`‚òÅÔ∏è Dados carregados da nuvem (${date.toLocaleTimeString()})`, false);
        } else {
             document.getElementById('list-content').innerHTML = '<div class="p-4 text-slate-400">Nenhum dado encontrado na nuvem ainda. Importe um Excel.</div>';
        }
      } catch (e) {
        console.error('Erro ao carregar:', e);
        document.getElementById('list-content').innerHTML = '<div class="p-4 text-red-400">Erro ao carregar dados. Verifique sua conex√£o.</div>';
      }
    }

    // --- RESTO DO C√ìDIGO ---

    function formatDateBR(date) {
      if (!date) return '';
      const d = String(date.getDate()).padStart(2, '0');
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const y = date.getFullYear();
      return `${d}/${m}/${y}`;
    }

    function groupByPlan(activities) {
      const grouped = {};
      activities.forEach(act => {
        const plan = act.plano || 'Sem Plano';
        if (!grouped[plan]) grouped[plan] = [];
        grouped[plan].push(act);
      });
      return grouped;
    }

    function getAverageProgress(planActivities) {
      if (planActivities.length === 0) return 0;
      const sum = planActivities.reduce((acc, act) => acc + act.progresso, 0);
      return Math.round(sum / planActivities.length);
    }

    function waitForXLSX(cb) {
      if (typeof XLSX !== 'undefined') cb();
      else setTimeout(() => waitForXLSX(cb), 50);
    }

    waitForXLSX(() => {
      // Tenta carregar da nuvem ao iniciar
      loadData();

      document.getElementById('collapse-all-btn').addEventListener('click', () => {
        const grouped = groupByPlan(activities);
        Object.keys(grouped).forEach(planName => {
          collapsedPlans[planName] = true;
        });
        renderList();
      });

      document.getElementById('expand-all-btn').addEventListener('click', () => {
        const grouped = groupByPlan(activities);
        Object.keys(grouped).forEach(planName => {
          collapsedPlans[planName] = false;
        });
        renderList();
      });

      document.getElementById('toggle-dashboard-btn').addEventListener('click', () => {
        dashboardVisible = !dashboardVisible;
        const panel = document.getElementById('dashboard-panel');
        const btn = document.getElementById('toggle-dashboard-btn');
        if (dashboardVisible) {
          panel.classList.remove('hidden');
          btn.textContent = 'üìä Ocultar Dashboard';
        } else {
          panel.classList.add('hidden');
          btn.textContent = 'üìä Mostrar Dashboard';
        }
      });

      document.getElementById('import-btn').addEventListener('click', () => {
        document.getElementById('import-modal').classList.remove('hidden');
      });

      document.getElementById('import-cancel').addEventListener('click', () => {
        document.getElementById('import-modal').classList.add('hidden');
      });

      document.getElementById('excel-file').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const wb = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
            const preview = document.getElementById('import-preview');
            if (rows.length === 0) {
              preview.innerHTML = '<span class="text-red-400">‚ùå Nenhum dado na planilha</span>';
            } else {
              const cols = Object.keys(rows[0]);
              preview.innerHTML = `<div class="mb-3"><strong class="text-indigo-300">‚úì ${rows.length} linhas encontradas</strong><br><strong class="text-purple-300">Colunas:</strong> ${cols.join(', ')}</div>`;
            }
            preview.classList.remove('hidden');
          } catch (err) {
            const preview = document.getElementById('import-preview');
            preview.innerHTML = `<span class="text-red-400">‚ùå ${err.message}</span>`;
            preview.classList.remove('hidden');
          }
        };
        reader.readAsArrayBuffer(file);
      });

      document.getElementById('import-confirm').addEventListener('click', async () => {
        const file = document.getElementById('excel-file').files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (evt) => {
          try {
            const wb = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
            
            const newTitle = ws['B1']?.v || 'Cronograma';
            // document.getElementById('plan-title').textContent = newTitle; // Removido para manter "GPP" fixo ou customizado

            const parseDate = (val) => {
              if (!val) return null;
              const s = String(val).trim();
              let m = s.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
              if (m) return new Date(m[3], m[2]-1, m[1]);
              m = s.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
              if (m) return new Date(m[1], m[2]-1, m[3]);
              const num = parseFloat(s);
              if (!isNaN(num) && num > 0) return new Date((num - 25569) * 86400 * 1000);
              return null;
            };

            const getCol = (obj, names) => {
              for (let name of names) {
                for (let key in obj) {
                  if (key.toLowerCase().trim() === name.toLowerCase().trim()) return String(obj[key]).trim();
                }
              }
              return '';
            };

            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            activities = rows.map(r => {
              const inicioDate = parseDate(getCol(r, ['inicio', 'start', 'data inicio', 'in√≠cio']));
              const fimDate = parseDate(getCol(r, ['fim', 'end', 'data fim']));
              const progresso = Math.min(100, Math.max(0, parseInt(getCol(r, ['progresso', 'progress', 'percentual'])) || 0));
              const isAtrasada = progresso < 100 && fimDate < hoje;
              return {
                plano: getCol(r, ['plano', 'plan', 'fase', 'phase']) || 'Sem Plano',
                atividade: getCol(r, ['atividade', 'activity', 'nome', 'name']) || '',
                tag: getCol(r, ['tag', 'subtag']) || '',
                inicio: inicioDate ? formatDateBR(inicioDate) : '',
                fim: fimDate ? formatDateBR(fimDate) : '',
                progresso: progresso,
                atrasada: isAtrasada,
                inicioDate: inicioDate,
                fimDate: fimDate
              };
            }).filter(a => a.atividade && a.inicioDate && a.fimDate).sort((a, b) => a.inicioDate - b.inicioDate);

            if (activities.length === 0) {
              showStatus('‚ùå Nenhuma atividade v√°lida', true);
              return;
            }

            renderList();
            updateDashboard();
            
            // AQUI SALVAMOS NA NUVEM
            await saveData();
            
            document.getElementById('import-modal').classList.add('hidden');
            showStatus(`‚úÖ Importado e salvo na nuvem!`, false);
          } catch (err) {
            showStatus(`‚ùå ${err.message}`, true);
          }
        };
        reader.readAsArrayBuffer(file);
      });
    });

    function showStatus(msg, isError) {
      const el = document.getElementById('import-status');
      el.textContent = msg;
      el.className = isError ? 'mt-4 p-3 rounded text-sm bg-red-500/20 text-red-400 border border-red-500/50' : 'mt-4 p-3 rounded text-sm bg-green-500/20 text-green-400 border border-green-500/50';
      el.classList.remove('hidden');
    }

    function togglePlan(planName) {
      collapsedPlans[planName] = !collapsedPlans[planName];
      renderList();
    }

    function renderList() {
      const listContent = document.getElementById('list-content');
      const grouped = groupByPlan(activities);
      const planNames = Object.keys(grouped).sort();

      listContent.innerHTML = planNames.map(planName => {
        const planActivities = grouped[planName];
        const isCollapsed = collapsedPlans[planName] || false;
        const avgProgress = getAverageProgress(planActivities);

        return `
          <div class="plan-group">
            <div class="plan-folder" onclick="togglePlan('${planName.replace(/'/g, "\\'")}')">
              <div class="plan-folder-title">
                ${isCollapsed ? 'üìÇ' : 'üìÅ'} ${planName}
                <span class="plan-count-badge">${planActivities.length}</span>
              </div>
              <div class="plan-folder-empty"></div>
              <div class="plan-folder-empty"></div>
              <div class="plan-folder-empty"></div>
              <div class="plan-folder-empty"></div>
            </div>
            ${isCollapsed ? `
              <div class="plan-progress-container">
                <div class="plan-progress-label">${avgProgress}%</div>
                <div class="plan-progress-bar">
                  <div class="plan-progress-fill" style="width: ${avgProgress}%"></div>
                </div>
              </div>
            ` : ''}
            ${planActivities.map((act, idx) => {
              const globalIdx = activities.indexOf(act);
              return `
                <div class="list-row ${isCollapsed ? 'hidden' : ''}" data-global-idx="${globalIdx}" data-plan="${planName}" onmouseenter="highlightActivityRow(${globalIdx})" onmouseleave="unhighlightActivityRow()">
                  <div class="list-cell">
                    <div class="activity-name">${act.atividade}</div>
                    <div class="activity-phase">${act.tag || '‚Äî'}</div>
                  </div>
                  <div class="list-cell">
                    <div class="cell-date">${act.inicio}</div>
                  </div>
                  <div class="list-cell">
                    <div class="cell-date">${act.fim}</div>
                  </div>
                  <div class="list-cell">
                    <div class="cell-progress">${act.progresso}%</div>
                  </div>
                  <div class="list-cell">
                    <div class="cell-status ${act.atrasada ? 'status-delayed' : 'status-on-time'}">
                      ${act.atrasada ? '‚ö†Ô∏è Atrasada' : '‚úÖ No prazo'}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }).join('');
    }

    function highlightActivityRow(globalIdx) {
      document.querySelectorAll('.list-row').forEach((el) => {
        if (parseInt(el.dataset.globalIdx) === globalIdx) {
          el.classList.add('highlighted');
          el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
      });
      highlightDashboardItem(globalIdx);
    }

    function unhighlightActivityRow() {
      document.querySelectorAll('.list-row').forEach(el => el.classList.remove('highlighted'));
      document.querySelectorAll('.dashboard-item').forEach(el => el.classList.remove('highlighted'));
    }

    function highlightDashboardItem(globalIdx) {
      document.querySelectorAll('.dashboard-item').forEach((el) => {
        if (parseInt(el.dataset.globalIdx) === globalIdx) {
          el.classList.add('highlighted');
        }
      });
    }

    function updateDashboard() {
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);

      const grouped = groupByPlan(activities);
      const planNames = Object.keys(grouped).sort();

      // Calcular totais gerais
      const totalDelayed = activities.filter(a => a.atrasada).length;
      const totalUpcoming = activities.filter(a => {
        const days = Math.ceil((a.inicioDate - hoje) / (1000*60*60*24));
        return days >= 0 && days <= 5;
      }).length;

      // Renderizar vis√£o geral
      const overviewHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
          <div class="dashboard-card" style="border-left: 4px solid #ef4444; text-align: center;">
            <div style="font-size: 28px; font-weight: bold; color: #ef4444;">${totalDelayed}</div>
            <div style="font-size: 11px; color: #a78bfa; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px;">üî¥ Em Atraso</div>
          </div>
          <div class="dashboard-card" style="border-left: 4px solid #3b82f6; text-align: center;">
            <div style="font-size: 28px; font-weight: bold; color: #3b82f6;">${totalUpcoming}</div>
            <div style="font-size: 11px; color: #a78bfa; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px;">üîµ Pr√≥ximos 5 Dias</div>
          </div>
        </div>
        <div style="height: 1px; background: rgba(99, 102, 241, 0.2); margin-bottom: 16px;"></div>
      `;

      document.getElementById('dashboard-overview').innerHTML = overviewHTML;

      let dashboardHTML = '';

      planNames.forEach(planName => {
        const planActivities = grouped[planName];

        // Atividades atrasadas do plano
        const delayedInPlan = planActivities.filter(a => a.atrasada);
        const delayedHTML = delayedInPlan.map((a) => {
          const globalIdx = activities.indexOf(a);
          return `
            <div class="dashboard-item delayed" data-global-idx="${globalIdx}" data-plan="${planName}" onmouseenter="highlightActivityRow(${globalIdx})" onmouseleave="unhighlightActivityRow()">
              <div class="dashboard-item-name">${a.atividade}</div>
              <div class="dashboard-item-phase">${a.tag || '‚Äî'}</div>
            </div>
          `;
        }).join('');

        // Pr√≥ximas atividades do plano
        const upcomingInPlan = planActivities.filter(a => {
          const days = Math.ceil((a.inicioDate - hoje) / (1000*60*60*24));
          return days >= 0 && days <= 5;
        });

        const upcomingHTML = upcomingInPlan.map((a) => {
          const globalIdx = activities.indexOf(a);
          return `
            <div class="dashboard-item upcoming" data-global-idx="${globalIdx}" data-plan="${planName}" onmouseenter="highlightActivityRow(${globalIdx})" onmouseleave="unhighlightActivityRow()">
              <div class="dashboard-item-name">${a.atividade}</div>
              <div class="dashboard-item-phase">${a.tag || '‚Äî'}</div>
            </div>
          `;
        }).join('');

        if (delayedInPlan.length > 0 || upcomingInPlan.length > 0) {
          dashboardHTML += `
            <div class="dashboard-plan-section">
              <div class="dashboard-plan-header">üìã ${planName}</div>
          `;

          if (delayedInPlan.length > 0) {
            dashboardHTML += `
              <div class="dashboard-card">
                <div class="dashboard-title">üî¥ Atrasadas (${delayedInPlan.length})</div>
                ${delayedHTML}
              </div>
            `;
          }

          if (upcomingInPlan.length > 0) {
            dashboardHTML += `
              <div class="dashboard-card">
                <div class="dashboard-title">üìÖ Pr√≥ximos 5 dias (${upcomingInPlan.length})</div>
                ${upcomingHTML}
              </div>
            `;
          }

          dashboardHTML += `</div>`;
        }
      });

      document.getElementById('dashboard-content').innerHTML = dashboardHTML || '<p class="text-xs text-slate-500 text-center py-4">Nenhuma atividade atrasada ou pr√≥xima</p>';
    }

    window.togglePlan = togglePlan;
    window.highlightActivityRow = highlightActivityRow;
    window.unhighlightActivityRow = unhighlightActivityRow;
  </script>
 </body>
</html>

